name: Jumpbox Docker Build

on: [push]

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v2
      - name: Prepare Secrets
        run: |
          echo "${{ secrets.SECRETS_TXT }}" >> $GITHUB_WORKSPACE/secrets.txt
  build:
    runs-on: ubuntu-latest
    services:
      secrets-server:
        image: nginx
        ports: 
          - 80:80
        options:  -v ${{ github.workspace }}:/usr/share/nginx/html:ro --name secrets-server --hostname secrets-server
    steps:
      - name: debug - pre checkout
        run: | 
          ls -l 
          pwd
          ls -l ${{ github.workspace }}
      - name: Checkout Source Code
        uses: actions/checkout@v2
      - name: debug - post checkout
        run: | 
          ls -l 
          pwd
          ls -l ${{ github.workspace }}
      - name: Prepare Secrets
        run: |
          echo "${{ secrets.SECRETS_TXT }}" >> $GITHUB_WORKSPACE/secrets.txt   
      - name: Check secrets container connection
        run: |
          # network label e87b52
          DOCKER_BUILD_NETWORK=$(docker network ls -f label=e87b52 --format "{{.Name}}" | head -1)
          docker run --network $DOCKER_BUILD_NETWORK --rm -t busybox  wget -SO- http://secrets-server/         
      - name: Build Docker Image
        run: |
          DOCKER_BUILD_NETWORK=$(docker network ls -f label=e87b52 --format "{{.Name}}" | head -1)  
          docker build -t yogendra/pcf-tools:latest .
  test:
    runs-on: ubuntu-latest    
    steps:
    - name: Test Docker Image
      run: |
        echo WIP
  push: 
    runs-on: ubuntu-latest
    steps:
    - name: Docker Login
      uses: Azure/docker-login@v1
      with:
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
        login-server: docker.io
    - name: Push Docker Image
      run: |
        docker push yogendra/pcf-tools:latest
