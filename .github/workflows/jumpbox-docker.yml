name: Jumpbox Docker Build

on: [push]

jobs:
  checkout:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
  prepare: 
    runs-on: ubuntu-latest
    steps:
    - name: Prepare Secrets
      run: |
        echo "${{ secrets.SECRETS_TXT }}" >> $GITHUB_WORKSPACE/secrets.txt  
    
  build:
    services:
      secrets_server:
        image: nginx
        ports: 
        - 80:80
        volumes: 
        - $GITHUB_WORKSPACE:/usr/share/nginx/html:ro  
    runs-on: ubuntu-latest
    steps:
    - name: Check secrets container connection
      run: |
        docker network ls 
        # network label e87b52
        DOCKER_BUILD_NETWORK=docker network ls -f label=e87b52 --format "{{.Name}}" | head -1
        echo Build Network: $DOCKER_BUILD_NETWORK
        echo ${{ job.services.secrets_server.ports[80] }}
        docker run --network $DOCKER_BUILD_NETWORK --rm -t busybox  wget -SO- http://secrets-server/Dockerfile 
        
#       run: |
#         docker 
#         docker run --name secrets-server --rm --volume :/usr/share/nginx/html:ro -d nginx
#     - name: Build Docker Image
#       run: |
#         docker build -t --arg yogendra/pcf-tools:latest .
#   test:
#     runs-on: ubuntu-latest    
#     steps:
#     - name: Test Docker Image
#       run: |
#         echo WIP
#   push: 
#     runs-on: ubuntu-latest
#     steps:
#     - name: Docker Login
#       uses: Azure/docker-login@v1
#       with:
#         username: ${{ secrets.REGISTRY_USERNAME }}
#         password: ${{ secrets.REGISTRY_PASSWORD }}
#         login-server: docker.io
#     - name: Push Docker Image
#       run: |
#         docker push yogendra/pcf-tools:latest
